# =============================================================================
# CIRCLECI CONFIGURATION FOR MERN CHAT APP
# =============================================================================
# Build and scan MERN chat app using Docker, Trivy, and SonarQube with Slack notifications

version: 2.1

# =============================================================================
# ORBS CONFIGURATION
# =============================================================================
# Prebuilt reusable CircleCI packages
orbs:
  docker: iamanonymous419/docker@5.0.0        # Your custom Docker orb (login, build, tag, push)
  trivy: iamanonymous419/trivy@1.0.0          # Your Trivy orb for security scanning
  sonar: iamanonymous419/sonar@1.0.0          # Your Sonar orb for static code analysis
  slack: circleci/slack@5.1.1                # ‚úÖ Official Slack orb for notifications

# =============================================================================
# EXECUTOR CONFIGURATION
# =============================================================================
# Define a reusable executor using a full VM with Docker pre-installed
executors:
  docker-executor:
    machine:
      image: ubuntu-2204:current              # Ubuntu VM for Docker operations
    working_directory: ~/repo                 # Working directory for all jobs

# =============================================================================
# PIPELINE PARAMETERS
# =============================================================================
# Parameter used for tagging Docker images (e.g., build-42)
parameters:
  image_tag:
    type: string
    default: build-<< pipeline.number >>

# =============================================================================
# JOB DEFINITIONS
# =============================================================================

# =============================================================================
# CLIENT BUILD AND SCAN JOB
# =============================================================================
jobs:
  build-client:
    executor: docker-executor
    steps:
      - checkout                              # ‚¨áÔ∏è Clone the repo code

      - docker/login:                         # üîê Login to DockerHub
          username: $DOCKERHUB_USERNAME
          password: DOCKERHUB_PASSWORD

      - docker/build:                         # üèóÔ∏è Build the client Docker image
          image-name: $DOCKERHUB_USERNAME/chat-client
          tag: << pipeline.parameters.image_tag >>
          dockerfile-path: ./frontend/Dockerfile
          build-context: ./frontend
          build-args: "VITE_STREAM_API_KEY=${VITE_STREAM_API_KEY}"

      - docker/push:                          # üì§ Push the build number tag to DockerHub
          image-name: $DOCKERHUB_USERNAME/chat-client
          tag: << pipeline.parameters.image_tag >>

      - docker/tag:                           # üè∑Ô∏è Tag the image as `latest`
          image-name: $DOCKERHUB_USERNAME/chat-client
          old-tag: << pipeline.parameters.image_tag >>
          new-tag: latest

      - docker/push:                          # üì§ Push the `latest` tag to DockerHub
          image-name: $DOCKERHUB_USERNAME/chat-client
          tag: latest

      - trivy/install                         # ‚öôÔ∏è Install Trivy CLI for scanning

      - trivy/scan:                           # üîç Scan client image for vulnerabilities
          image: $DOCKERHUB_USERNAME/chat-client:latest
          output: client-scan.txt
          format: table
          severity: HIGH,CRITICAL

      - store_artifacts:                      # üíæ Save scan report as artifact
          path: trivy-reports/client-scan.txt
          destination: trivy-client-report

# =============================================================================
# SERVER BUILD AND SCAN JOB
# =============================================================================
  build-server:
    executor: docker-executor
    steps:
      - checkout

      - docker/login:
          username: $DOCKERHUB_USERNAME
          password: DOCKERHUB_PASSWORD

      - docker/build:
          image-name: $DOCKERHUB_USERNAME/chat-server
          tag: << pipeline.parameters.image_tag >>
          dockerfile-path: ./backend/Dockerfile
          build-context: ./backend

      - docker/push:                          # üì§ Push the build number tag to DockerHub
          image-name: $DOCKERHUB_USERNAME/chat-server
          tag: << pipeline.parameters.image_tag >>

      - docker/tag:
          image-name: $DOCKERHUB_USERNAME/chat-server
          old-tag: << pipeline.parameters.image_tag >>
          new-tag: latest

      - docker/push:
          image-name: $DOCKERHUB_USERNAME/chat-server
          tag: latest

      - trivy/install

      - trivy/scan:
          image: $DOCKERHUB_USERNAME/chat-server:latest
          output: server-scan.txt
          format: table
          severity: HIGH,CRITICAL

      - store_artifacts:
          path: trivy-reports/server-scan.txt
          destination: trivy-server-report

# =============================================================================
# KUBERNETES MANIFEST UPDATE JOB
# =============================================================================
  update-manifests:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      # Update backend image tag
      - run:
          name: Update backend image tag
          command: |
            sed -i "s|anonymous292009/chat-server:.*|anonymous292009/chat-server:<< pipeline.parameters.image_tag >>|" kubernetes/backend/dep.yaml

      # Update frontend image tag
      - run:
          name: Update frontend image tag
          command: |
            sed -i "s|anonymous292009/chat-client:.*|anonymous292009/chat-client:<< pipeline.parameters.image_tag >>|" kubernetes/frontend/dep.yaml

      # Commit and push changes back to GitHub
      - run:
          name: Commit updated manifests
          command: |
            git config --global user.email "ci-bot@circleci.com"
            git config --global user.name "CircleCI Bot"

            git add kubernetes/backend/dep.yaml kubernetes/frontend/dep.yaml
            git commit -m "chore(ci): update image tags to << pipeline.parameters.image_tag >> [skip ci]" || echo "No changes to commit"

            # Push using token
            git push https://$GITHUB_TOKEN@github.com/iamanonymous419/streamify.git HEAD:main

# =============================================================================
# SLACK NOTIFICATION JOB
# =============================================================================
  notify-slack:
    executor: docker-executor
    steps:
      - slack/notify:
          event: pass
          template: basic_success_1
      - slack/notify:
          event: fail
          template: basic_fail_1

# =============================================================================
# WORKFLOW CONFIGURATION
# =============================================================================
# Controls the order in which jobs run
workflows:
  build-and-deploy:
    jobs:
      - sonar/scan:                           # ‚úÖ Run SonarQube scan first
          project_key: iamanonymous419_streamify
          organization: iamanonymous419
          sources: .
          exclusions: "**/node_modules/**,**/dist/**,**/build/**"
          host_url: https://sonarcloud.io
          sonar_token: SONAR_TOKEN            # üîê Secure token stored in project env vars

      - build-client:                         # üß± Build client only after Sonar
          requires:
            - sonar/scan

      - build-server:                         # üß± Build server only after Sonar
          requires:
            - sonar/scan

      - update-manifests:                    # üìù Update manifests after both builds
          requires:
            - build-client
            - build-server

      - notify-slack:                         # üì¢ Slack notification at end
          requires:
            - update-manifests